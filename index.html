<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro de Calificaciones</title>
<style>
/* Fuente y base */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Inter',sans-serif;
  background:linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 50%,#16213e 100%);
  color:#e0e6ed;min-height:100vh;display:flex;flex-direction:column;align-items:center;
  padding:20px;position:relative;overflow-x:hidden
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(circle at 20% 50%, rgba(120,119,198,0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255,119,198,0.08) 0%, transparent 50%),
    radial-gradient(circle at 40% 80%, rgba(120,219,255,0.06) 0%, transparent 50%)
}
.container{position:relative;z-index:1;width:100%;max-width:900px}
h1{
  font-size:3rem;font-weight:700;
  background:linear-gradient(135deg,#00d4ff 0%,#ff00ff 50%,#ff4081 100%);
  background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  text-align:center;margin:40px 0;text-shadow:0 0 30px rgba(0,212,255,0.3)
}

/* Tarjetas y controles */
.glass-card{
  background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,0.1);border-radius:20px;
  padding:24px;margin:16px 0;box-shadow:0 20px 40px rgba(0,0,0,0.3);
  transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease
}
.glass-card:hover{transform:translateY(-4px);box-shadow:0 30px 60px rgba(0,0,0,0.4);border-color:rgba(255,255,255,0.2)}
.hidden{display:none !important}
.search-section{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
input,button{
  padding:12px 16px;font-size:16px;border:none;border-radius:12px;transition:.2s;font-weight:500
}
input{
  background:rgba(255,255,255,0.08);color:#e0e6ed;border:1px solid rgba(255,255,255,0.12);
  min-width:220px
}
input:focus{
  outline:none;background:rgba(255,255,255,0.12);border-color:#00d4ff;
  box-shadow:0 0 20px rgba(0,212,255,0.3);transform:scale(1.01)
}
input::placeholder{color:rgba(224,230,237,0.6)}
button{
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;cursor:pointer;font-weight:600;
  text-transform:uppercase;letter-spacing:.5px
}
button:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(102,126,234,0.4)}
.btn-primary{background:linear-gradient(135deg,#00d4ff 0%,#ff00ff 100%)}
.btn-success{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
.btn-edit{background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);color:#333}
.btn-delete{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
.btn-ghost{
  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);
  text-transform:none;letter-spacing:0
}

/* Formulario */
.form-grid{display:grid;grid-template-columns:1fr;gap:16px;margin:16px 0}
.form-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.form-row input{flex:1;min-width:200px}

/* Notas */
.calificaciones-container{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:16px 0;padding:16px;
  background:rgba(255,255,255,0.03);border-radius:14px;border:1px solid rgba(255,255,255,0.06)
}
.nota-item{
  display:flex;gap:8px;align-items:center;background:rgba(0,212,255,0.08);padding:8px;border-radius:12px;
  border:1px solid rgba(0,212,255,0.15)
}
.nota-item input{
  text-align:center;font-weight:600;flex:1;background:transparent;border:1px solid rgba(0,212,255,0.2)
}
.nota-item .mini{padding:8px 10px;font-size:13px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2)}

/* Promedio */
.promedio{
  text-align:center;font-size:1.4rem;font-weight:700;margin:10px 0;padding:12px;
  background:linear-gradient(135deg,rgba(0,212,255,0.1) 0%, rgba(255,0,255,0.1) 100%);
  border-radius:12px;border:1px solid rgba(255,255,255,0.1)
}
.promedio.excelente{color:#00ff88}
.promedio.bueno{color:#00d4ff}
.promedio.regular{color:#ffaa00}
.promedio.deficiente{color:#ff4444}

/* Resultado */
.result-card{
  background:rgba(255,255,255,0.08);border-radius:15px;padding:20px;margin:12px 0;
  border-left:4px solid #00d4ff;box-shadow:0 10px 30px rgba(0,0,0,0.2)
}
.result-info{font-size:1.05rem;line-height:1.7}
.result-info strong{color:#00d4ff}

/* Botonera */
.btn-group{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:12px}

/* Notificaciones */
.notification{
  position:fixed;top:20px;right:20px;padding:12px 18px;border-radius:12px;color:white;font-weight:600;
  z-index:1000;transform:translateX(400px);transition:transform .25s ease
}
.notification.success{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
.notification.error{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
.notification.show{transform:translateX(0)}

/* Sugerencias */
.suggest-box{
  position:absolute;top:48px;left:0;width:100%;z-index:10;border-radius:14px;
  background:rgba(255,255,255,0.06);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,0.12);
  overflow:hidden
}
.suggest-item{padding:10px 12px;cursor:pointer}
.suggest-item:hover{background:rgba(255,255,255,0.1)}

@media (max-width: 768px){
  h1{font-size:2.4rem}
  .glass-card{padding:18px}
  .calificaciones-container{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
}
</style>
</head>
<body>

<div class="container">
  <h1>Registro de Calificaciones</h1>

  <!-- Buscador -->
  <div id="searchSection" class="glass-card">
    <div class="search-section">
      <div style="position:relative;flex:1;min-width:260px">
        <input id="searchName" type="text" placeholder="Buscar estudiante por nombre..." maxlength="60" style="width:100%">
        <div id="suggestions" class="suggest-box hidden"></div>
      </div>
      <button class="btn-primary" onclick="buscar()">Buscar</button>
      <button class="btn-success" onclick="nuevoRegistro()">Nuevo</button>
      <button class="btn-delete" onclick="eliminarTodo()">Eliminar todo</button>
    </div>
  </div>

  <!-- Formulario -->
  <div id="formSection" class="glass-card hidden">
    <h2 id="formTitle" style="text-align:center;color:#00d4ff;margin-bottom:6px">Nuevo Registro</h2>
    <div class="form-grid">
      <div class="form-row">
        <input id="nombre" type="text" maxlength="60" placeholder="Nombre completo del estudiante">
      </div>
      <div class="form-row">
        <input id="asignatura" type="text" maxlength="60" placeholder="Nombre de la asignatura">
      </div>
      <div class="form-row">
        <input id="numCalificaciones" type="number" min="1" max="10" placeholder="Número de calificaciones (1-10)" onchange="generarCampos()">
        <button class="btn-ghost" type="button" onclick="agregarNota()">Agregar nota</button>
        <button class="btn-ghost" type="button" onclick="limpiarNotas()">Limpiar notas</button>
      </div>
    </div>

    <div id="calificacionesContainer" class="calificaciones-container"></div>
    <div id="promedio" class="promedio"></div>

    <div class="btn-group">
      <button class="btn-success" onclick="guardar()">Guardar</button>
      <button class="btn-primary" onclick="cancelar()">Cancelar</button>
    </div>
  </div>

  <!-- Resultados -->
  <div id="resultSection" class="glass-card hidden">
    <div class="result-card">
      <div id="resultData" class="result-info"></div>
    </div>
    <div class="btn-group">
      <button class="btn-edit" onclick="editar()">Editar</button>
      <button class="btn-delete" onclick="eliminarRegistro()">Eliminar</button>
      <button class="btn-primary" onclick="volverBusqueda()">Nueva búsqueda</button>
      <button class="btn-success" onclick="exportarPDF()">Exportar PDF</button>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkQfCwP1d5Xn3k+5hSa3Y5cMo+5q0A8KzjH3qS1lq5d3I3bVfQvE5nqGg7l0g0lq9l2M2CwKqv2yW8F8q1f3WQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* Estado */
let registros = JSON.parse(localStorage.getItem('registros') || '{}'); // { [nombre]: { asignatura, notas: [string] } }
let registroActual = null;

/* Utilidades UI */
function showNotification(message, type='success'){
  const n = document.getElementById('notification');
  n.textContent = message;
  n.className = `notification ${type} show`;
  setTimeout(()=> n.classList.remove('show'), 2800);
}
function guardarRegistros(){ localStorage.setItem('registros', JSON.stringify(registros)); }

/* Sugerencias en vivo */
const searchInput = document.getElementById('searchName');
const suggestionsBox = document.getElementById('suggestions');

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  suggestionsBox.innerHTML = '';
  if(!q){
    suggestionsBox.classList.add('hidden');
    return;
  }
  const nombres = Object.keys(registros);
  const matches = nombres.filter(n => n.toLowerCase().includes(q)).slice(0, 8);
  if(matches.length === 0){
    suggestionsBox.classList.add('hidden');
    return;
  }
  matches.forEach(nombre => {
    const item = document.createElement('div');
    item.className = 'suggest-item';
    item.textContent = nombre;
    item.onclick = () => {
      searchInput.value = nombre;
      suggestionsBox.classList.add('hidden');
      buscar();
    };
    suggestionsBox.appendChild(item);
  });
  suggestionsBox.classList.remove('hidden');
});
document.addEventListener('click', (e) => {
  if(!e.target.closest('#suggestions') && !e.target.closest('#searchName')){
    suggestionsBox.classList.add('hidden');
  }
});
searchInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){ e.preventDefault(); buscar(); }
});

/* Navegación */
function nuevoRegistro(){
  registroActual = null;
  document.getElementById('formTitle').textContent = 'Nuevo Registro';
  limpiarFormulario();
  document.getElementById('searchSection').classList.add('hidden');
  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById('formSection').classList.remove('hidden');
}
function cancelar(){
  document.getElementById('formSection').classList.add('hidden');
  document.getElementById('searchSection').classList.remove('hidden');
  limpiarFormulario();
}
function volverBusqueda(){
  registroActual = null;
  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById('searchSection').classList.remove('hidden');
  document.getElementById('searchName').value = '';
}

/* Formulario y notas */
function limpiarFormulario(){
  document.getElementById('nombre').value = '';
  document.getElementById('asignatura').value = '';
  document.getElementById('numCalificaciones').value = '';
  document.getElementById('calificacionesContainer').innerHTML = '';
  const p = document.getElementById('promedio');
  p.textContent = ''; p.className = 'promedio';
}
function agregarNota(valor=''){
  const container = document.getElementById('calificacionesContainer');
  const item = document.createElement('div');
  item.className = 'nota-item';

  const input = document.createElement('input');
  input.type = 'number'; input.min = '1'; input.max = '7'; input.step = '0.1';
  input.placeholder = `Nota ${container.children.length + 1}`;
  input.value = valor;
  input.addEventListener('input', () => { validarBorde(input); calcularPromedio(); });

  const btn = document.createElement('button');
  btn.type = 'button'; btn.className = 'mini btn-delete'; btn.textContent = 'Eliminar';
  btn.onclick = () => { item.remove(); renumerarNotas(); calcularPromedio(); };

  item.appendChild(input);
  item.appendChild(btn);
  container.appendChild(item);
}
function limpiarNotas(){
  document.getElementById('calificacionesContainer').innerHTML = '';
  document.getElementById('numCalificaciones').value = '';
  calcularPromedio();
}
function generarCampos(){
  const n = parseInt(document.getElementById('numCalificaciones').value) || 0;
  const container = document.getElementById('calificacionesContainer');
  container.innerHTML = '';
  if(n>0 && n<=10){ for(let i=0;i<n;i++) agregarNota(''); }
  calcularPromedio();
}
function renumerarNotas(){
  document.querySelectorAll('.nota-item input').forEach((inp, i) => inp.placeholder = `Nota ${i+1}`);
}
function validarBorde(input){
  const v = parseFloat(input.value);
  if(input.value && (isNaN(v) || v < 1 || v > 7)) input.style.borderColor = '#ff6b6b';
  else input.style.borderColor = 'rgba(0, 212, 255, 0.2)';
}
function leerNotas(){
  return [...document.querySelectorAll('.nota-item input')]
    .map(i => i.value.trim())
    .filter(v => v !== '')
    .map(parseFloat)
    .filter(n => !isNaN(n));
}
function calcularPromedio(){
  const notas = leerNotas();
  const el = document.getElementById('promedio');
  if(notas.length === 0){
    el.textContent = ''; el.className = 'promedio'; return;
  }
  const p = notas.reduce((a,b)=>a+b,0) / notas.length;
  const t = p.toFixed(2);
  let clase='deficiente', emoji='❌';
  if(p>=6){ clase='excelente'; emoji='🌟'; }
  else if(p>=5){ clase='bueno'; emoji='👍'; }
  else if(p>=4){ clase='regular'; emoji='⚠️'; }
  el.textContent = `${emoji} Promedio: ${t}`;
  el.className = `promedio ${clase}`;
}

/* CRUD */
function guardar(){
  const nombre = document.getElementById('nombre').value.trim();
  const asignatura = document.getElementById('asignatura').value.trim();
  const notas = leerNotas();

  if(!nombre || !asignatura){ showNotification('Completa nombre y asignatura','error'); return; }
  if(notas.length === 0){ showNotification('Ingresa al menos una calificación','error'); return; }
  if(!notas.every(n => n>=1 && n<=7)){ showNotification('Todas las notas deben estar entre 1.0 y 7.0','error'); return; }

  // Conflictos de nombre
  if(registroActual && registroActual !== nombre){
    if(registros[nombre] && !confirm(`Ya existe "${nombre}". ¿Sobrescribir?`)) return;
    delete registros[registroActual];
  } else if(!registroActual && registros[nombre]){
    if(!confirm(`Ya existe "${nombre}". ¿Sobrescribir?`)) return;
  }

  registros[nombre] = { asignatura, notas: notas.map(n => n.toFixed(1)) };
  guardarRegistros();
  showNotification(`Registro guardado para ${nombre}`,'success');
  cancelar();
}

function buscar(){
  const nombre = document.getElementById('searchName').value.trim();
  if(!nombre){ showNotification('Ingresa un nombre para buscar','error'); return; }

  const reg = registros[nombre];
  if(!reg){ showNotification(`No se encontró un registro para "${nombre}"`,'error'); return; }

  registroActual = nombre;
  const notasNum = reg.notas.map(parseFloat).filter(n => !isNaN(n));
  const promedio = notasNum.length ? (notasNum.reduce((a,b)=>a+b,0)/notasNum.length).toFixed(2) : 'N/A';

  document.getElementById('resultData').innerHTML = `
    <div style="margin-bottom:10px;"><strong>👤 Estudiante:</strong> ${nombre}</div>
    <div style="margin-bottom:10px;"><strong>📚 Asignatura:</strong> ${reg.asignatura}</div>
    <div style="margin-bottom:10px;"><strong>📝 Calificaciones:</strong> ${reg.notas.join(' • ')}</div>
    <div style="margin-bottom:10px;"><strong>📊 Promedio:</strong> ${promedio}</div>
    <div><strong>📈 Total de notas:</strong> ${reg.notas.length}</div>
  `;

  document.getElementById('searchSection').classList.add('hidden');
  document.getElementById('formSection').classList.add('hidden');
  document.getElementById('resultSection').classList.remove('hidden');

  showNotification(`Registro encontrado: ${nombre}`,'success');
}

function editar(){
  if(!registroActual) return;
  const { asignatura, notas } = registros[registroActual];
  document.getElementById('formTitle').textContent = `Editando: ${registroActual}`;
  document.getElementById('nombre').value = registroActual;
  document.getElementById('asignatura').value = asignatura;

  const container = document.getElementById('calificacionesContainer');
  container.innerHTML = '';
  notas.forEach(n => agregarNota(n));
  document.getElementById('numCalificaciones').value = notas.length;
  calcularPromedio();

  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById('formSection').classList.remove('hidden');
}

function eliminarRegistro(){
  if(!registroActual) return;
  const ok = confirm(`¿Eliminar el registro de "${registroActual}"? Esta acción no se puede deshacer.`);
  if(!ok) return;

  delete registros[registroActual];
  guardarRegistros();
  showNotification(`Registro eliminado: ${registroActual}`,'success');
  registroActual = null;

  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById('searchSection').classList.remove('hidden');
  document.getElementById('searchName').value = '';
}

function eliminarTodo(){
  if(Object.keys(registros).length === 0){
    showNotification('No hay registros para eliminar','error'); return;
  }
  if(!confirm('¿Eliminar TODOS los registros? Esta acción no se puede deshacer.')) return;
  registros = {};
  guardarRegistros();
  showNotification('Todos los registros fueron eliminados','success');
  registroActual = null;
  document.getElementById('formSection').classList.add('hidden');
  document.getElementById('resultSection').classList.add('hidden');
  document.getElementById('searchSection').classList.remove('hidden');
  document.getElementById('searchName').value = '';
  limpiarFormulario();
}

/* Exportar a PDF (registro actual) */
function exportarPDF(){
  if(!registroActual){ showNotification('No hay registro seleccionado','error'); return; }
  const reg = registros[registroActual];
  const notasNum = reg.notas.map(parseFloat).filter(n=>!isNaN(n));
  const promedio = notasNum.length ? (notasNum.reduce((a,b)=>a+b,0)/notasNum.length).toFixed(2) : 'N/A';

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });

  const margin = 56;
  let y = margin;

  // Título
  doc.setFont('helvetica','bold'); doc.setFontSize(20);
  doc.text('Registro de Calificaciones', margin, y);
  y += 28;

  // Datos
  doc.setFontSize(12); doc.setFont('helvetica','normal');
  doc.text(`Estudiante: ${registroActual}`, margin, y); y += 18;
  doc.text(`Asignatura: ${reg.asignatura}`, margin, y); y += 18;
  doc.text(`Total de notas: ${reg.notas.length}`, margin, y); y += 18;
  doc.text(`Promedio: ${promedio}`, margin, y); y += 24;

  // Notas
  doc.setFont('helvetica','bold');
  doc.text('Notas:', margin, y); y += 18;
  doc.setFont('helvetica','normal');

  const lineHeight = 18;
  const maxWidth = 500;
  const notasStr = reg.notas.join(' • ');
  const lines = doc.splitTextToSize(notasStr, maxWidth);
  lines.forEach(line => { doc.text(line, margin, y); y += lineHeight; });

  // Pie
  y += 24;
  doc.setDrawColor(200); doc.line(margin, y, margin+maxWidth, y); y += 16;
  doc.setFontSize(10);
  const fecha = new Date().toLocaleString();
  doc.text(`Generado: ${fecha}`, margin, y);

  const nombreArchivo = `Registro_${sanitizeFile(registroActual)}_${sanitizeFile(reg.asignatura)}.pdf`;
  doc.save(nombreArchivo);
}

function sanitizeFile(s){
  return String(s).replace(/[\\/:*?"<>|]+/g,'_').replace(/\s+/g,'_');
}

/* Validación visual delegada para inputs de notas */
document.addEventListener('input', (e) => {
  if(e.target.closest('.nota-item') && e.target.tagName === 'INPUT'){ validarBorde(e.target); }
});
</script>

</body>
</html>
