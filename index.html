<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Registro de Calificaciones</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#0c0c0c,#1a1a2e 50%,#16213e);color:#e0e6ed;min-height:100vh;display:flex;justify-content:flex-start;align-items:center;flex-direction:column;padding:20px}
.container{width:100%;max-width:900px}
h1{font-size:2.6rem;font-weight:700;margin:28px 0;background:linear-gradient(135deg,#00d4ff 0%,#ff00ff 50%,#ff4081 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.glass{background:rgba(255,255,255,.06);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:20px;margin:14px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,button{padding:12px 14px;border:none;border-radius:12px;font-size:15px}
input{min-width:220px;background:rgba(255,255,255,.08);color:#e0e6ed;border:1px solid rgba(255,255,255,.12)}
input:focus{outline:none;border-color:#00d4ff;box-shadow:0 0 12px rgba(0,212,255,.35)}
button{cursor:pointer;color:#fff;background:linear-gradient(135deg,#667eea,#764ba2)}
button:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,0,0,.25)}
.btn-primary{background:linear-gradient(135deg,#00d4ff,#ff00ff)}
.btn-success{background:linear-gradient(135deg,#4facfe,#00f2fe)}
.btn-edit{background:linear-gradient(135deg,#ffecd2,#fcb69f);color:#333}
.btn-danger{background:linear-gradient(135deg,#ff6b6b,#ee5a52)}
.grid{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 0}
.califs{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;padding:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px}
.nota{display:flex;gap:8px}
.nota input{flex:1;text-align:center;border:1px solid rgba(0,212,255,.25)}
.mini{padding:8px 10px;font-size:13px}
.prom{margin-top:8px;text-align:center;padding:10px;border:1px solid rgba(255,255,255,.1);border-radius:10px}
.prom.excelente{color:#00ff88}.prom.bueno{color:#00d4ff}.prom.regular{color:#ffaa00}.prom.deficiente{color:#ff5555}
.result{border-left:4px solid #00d4ff}
.center{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:10px}
.note{position:fixed;top:16px;right:16px;padding:12px 16px;border-radius:12px;color:#fff;transform:translateX(150%);transition:.25s;z-index:1000}
.note.show{transform:translateX(0)}
.note.ok{background:linear-gradient(135deg,#4facfe,#00f2fe)}.note.err{background:linear-gradient(135deg,#ff6b6b,#ee5a52)}
.suggest{position:absolute;top:46px;left:0;width:100%;z-index:10;border-radius:12px;background:rgba(255,255,255,.06);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.12);overflow:hidden}
.s-item{padding:10px 12px;cursor:pointer}.s-item:hover{background:rgba(255,255,255,.1)}
@media(max-width:768px){h1{font-size:2.2rem}}
</style>
</head>
<body>
<div class="container">
  <h1>Registro de Calificaciones</h1>

  <!-- Buscador -->
  <div id="searchSection" class="glass">
    <div class="row">
      <div style="position:relative;flex:1;min-width:260px">
        <input id="searchName" type="text" placeholder="Buscar estudiante por nombre..." maxlength="60" style="width:100%">
        <div id="suggestions" class="suggest hidden"></div>
      </div>
      <button class="btn-primary" onclick="buscar()">Buscar</button>
      <button class="btn-success" onclick="nuevoRegistro()">Nuevo Registro</button>
      <button class="btn-success" onclick="exportarPDFPorAsignatura()">Exportar PDF</button>
      <button class="btn-danger" onclick="eliminarTodo()">Eliminar todo</button>
    </div>
  </div>

  <!-- Formulario -->
  <div id="formSection" class="glass hidden">
    <h3 id="formTitle" style="text-align:center;color:#00d4ff;margin-bottom:6px">Nuevo Registro</h3>
    <div class="grid">
      <input id="nombre" type="text" maxlength="60" placeholder="Nombre completo del estudiante">
      <input id="asignatura" type="text" maxlength="60" placeholder="Nombre de la asignatura">
      <div class="row">
        <input id="numCalificaciones" type="number" min="1" max="10" placeholder="N√∫mero de calificaciones (1-10)" onchange="generarCampos()">
        <button class="mini" type="button" onclick="agregarNota()">Agregar nota</button>
        <button class="mini" type="button" onclick="limpiarNotas()">Limpiar notas</button>
      </div>
    </div>
    <div id="calificacionesContainer" class="califs"></div>
    <div id="promedio" class="prom"></div>
    <div class="center">
      <button class="btn-success" onclick="guardar()">Guardar</button>
      <button class="btn-primary" onclick="cancelar()">Cancelar</button>
    </div>
  </div>

  <!-- Resultados -->
  <div id="resultSection" class="glass hidden">
    <div class="glass result">
      <div id="resultData" class="grid"></div>
    </div>
    <div class="center">
      <button class="btn-edit" onclick="editar()">Editar</button>
      <button class="btn-danger" onclick="eliminarRegistro()">Eliminar</button>
      <button class="btn-primary" onclick="volverBusqueda()">Nueva b√∫squeda</button>
    </div>
  </div>
</div>

<div id="toast" class="note"></div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkQfCwP1d5Xn3k+5hSa3Y5cMo+5q0A8KzjH3qS1lq5d3I3bVfQvE5nqGg7l0g0lq9l2M2CwKqv2yW8F8q1f3WQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
/* Estado */
let registros = JSON.parse(localStorage.getItem('registros')||'{}'); // { nombre: { asignatura, notas:[string] } }
let registroActual = null;

/* Utilidades */
const $ = id=>document.getElementById(id);
function toast(msg,type='ok'){const t=$('toast');t.textContent=msg;t.className=`note ${type} show`;setTimeout(()=>t.classList.remove('show'),2600)}
function save(){localStorage.setItem('registros',JSON.stringify(registros))}
function sanitize(s){return String(s).replace(/[\\/:*?"<>|]+/g,'_').replace(/\s+/g,'_')}

/* B√∫squeda en vivo */
const inputSearch=$('searchName'), boxSug=$('suggestions');
inputSearch.addEventListener('input',()=>{
  const q=inputSearch.value.trim().toLowerCase(); boxSug.innerHTML='';
  if(!q){boxSug.classList.add('hidden');return}
  const matches=Object.keys(registros).filter(n=>n.toLowerCase().includes(q)).slice(0,8);
  if(matches.length===0){boxSug.classList.add('hidden');return}
  matches.forEach(n=>{const d=document.createElement('div');d.className='s-item';d.textContent=n;d.onclick=()=>{inputSearch.value=n;boxSug.classList.add('hidden');buscar()};boxSug.appendChild(d)});
  boxSug.classList.remove('hidden');
});
document.addEventListener('click',e=>{ if(!e.target.closest('#suggestions') && !e.target.closest('#searchName')) boxSug.classList.add('hidden') });
inputSearch.addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();buscar()} });

/* Navegaci√≥n */
function nuevoRegistro(){registroActual=null;$('formTitle').textContent='Nuevo Registro';limpiarFormulario();$('searchSection').classList.add('hidden');$('resultSection').classList.add('hidden');$('formSection').classList.remove('hidden')}
function cancelar(){$('formSection').classList.add('hidden');$('searchSection').classList.remove('hidden');limpiarFormulario()}
function volverBusqueda(){registroActual=null;$('resultSection').classList.add('hidden');$('searchSection').classList.remove('hidden');$('searchName').value=''}

/* Formulario / notas */
function limpiarFormulario(){$('nombre').value='';$('asignatura').value='';$('numCalificaciones').value='';$('calificacionesContainer').innerHTML='';const p=$('promedio');p.textContent='';p.className='prom'}
function agregarNota(valor=''){const c=$('calificacionesContainer');const wrap=document.createElement('div');wrap.className='nota';const i=document.createElement('input');i.type='number';i.min='1';i.max='7';i.step='0.1';i.placeholder=`Nota ${c.children.length+1}`;i.value=valor;i.oninput=()=>{validarNota(i);calcProm()};const b=document.createElement('button');b.type='button';b.className='mini btn-danger';b.textContent='Eliminar';b.onclick=()=>{wrap.remove();renum();calcProm()};wrap.appendChild(i);wrap.appendChild(b);c.appendChild(wrap)}
function limpiarNotas(){$('calificacionesContainer').innerHTML='';$('numCalificaciones').value='';calcProm()}
function generarCampos(){const n=parseInt($('numCalificaciones').value)||0;const c=$('calificacionesContainer');c.innerHTML='';for(let i=0;i<n && i<10;i++)agregarNota('');calcProm()}
function renum(){document.querySelectorAll('.nota input').forEach((el,i)=>el.placeholder=`Nota ${i+1}`)}
function validarNota(input){const v=parseFloat(input.value);input.style.borderColor=(input.value && (isNaN(v)||v<1||v>7))?'#ff6b6b':'rgba(0,212,255,.25)'}
function leerNotas(){return [...document.querySelectorAll('.nota input')].map(e=>e.value.trim()).filter(v=>v!=='').map(parseFloat).filter(n=>!isNaN(n))}
function calcProm(){const ns=leerNotas();const p=$('promedio');if(ns.length===0){p.textContent='';p.className='prom';return}const m=ns.reduce((a,b)=>a+b,0)/ns.length;let cls='deficiente',em='‚ùå';if(m>=6)cls='excelente',em='üåü';else if(m>=5)cls='bueno',em='üëç';else if(m>=4)cls='regular',em='‚ö†Ô∏è';p.textContent=`${em} Promedio: ${m.toFixed(2)}`;p.className=`prom ${cls}`}

/* CRUD */
function guardar(){
  const nombre=$('nombre').value.trim(), asignatura=$('asignatura').value.trim(), notas=leerNotas();
  if(!nombre||!asignatura){toast('Completa nombre y asignatura','err');return}
  if(notas.length===0){toast('Ingresa al menos una calificaci√≥n','err');return}
  if(!notas.every(n=>n>=1&&n<=7)){toast('Notas deben estar entre 1.0 y 7.0','err');return}
  if(registroActual&&registroActual!==nombre){ if(registros[nombre] && !confirm(`"${nombre}" ya existe. ¬øSobrescribir?`)) return; delete registros[registroActual] }
  else if(!registroActual&&registros[nombre]){ if(!confirm(`"${nombre}" ya existe. ¬øSobrescribir?`)) return }
  registros[nombre]={asignatura, notas:notas.map(n=>n.toFixed(1))}; save(); toast(`Registro guardado para ${nombre}`,'ok'); cancelar();
}
function buscar(){
  const nombre=$('searchName').value.trim();
  if(!nombre){toast('Ingresa un nombre para buscar','err');return}
  const reg=registros[nombre];
  if(!reg){toast(`No se encontr√≥ "${nombre}"`,'err');return}
  registroActual=nombre;
  const notasNum=reg.notas.map(parseFloat).filter(n=>!isNaN(n)); const prom=notasNum.length?(notasNum.reduce((a,b)=>a+b,0)/notasNum.length).toFixed(2):'N/A';
  $('resultData').innerHTML=`
    <div><strong>üë§ Estudiante:</strong> ${nombre}</div>
    <div><strong>üìö Asignatura:</strong> ${reg.asignatura}</div>
    <div><strong>üìù Calificaciones:</strong> ${reg.notas.join(' ‚Ä¢ ')}</div>
    <div><strong>üìä Promedio:</strong> ${prom}</div>
    <div><strong>üìà Total de notas:</strong> ${reg.notas.length}</div>`;
  $('searchSection').classList.add('hidden');$('formSection').classList.add('hidden');$('resultSection').classList.remove('hidden'); toast(`Registro encontrado: ${nombre}`,'ok');
}
function editar(){
  if(!registroActual)return; const {asignatura,notas}=registros[registroActual];
  $('formTitle').textContent=`Editando: ${registroActual}`; $('nombre').value=registroActual; $('asignatura').value=asignatura;
  const c=$('calificacionesContainer'); c.innerHTML=''; notas.forEach(n=>agregarNota(n)); $('numCalificaciones').value=notas.length; calcProm();
  $('resultSection').classList.add('hidden'); $('formSection').classList.remove('hidden');
}
function eliminarRegistro(){
  if(!registroActual)return; if(!confirm(`¬øEliminar el registro de "${registroActual}"?`)) return;
  delete registros[registroActual]; save(); toast('Registro eliminado','ok'); registroActual=null; $('resultSection').classList.add('hidden'); $('searchSection').classList.remove('hidden'); $('searchName').value='';
}
function eliminarTodo(){
  if(Object.keys(registros).length===0){toast('No hay registros','err');return}
  if(!confirm('¬øEliminar TODOS los registros?')) return; registros={}; save(); toast('Todos los registros eliminados','ok'); registroActual=null; $('formSection').classList.add('hidden'); $('resultSection').classList.add('hidden'); $('searchSection').classList.remove('hidden'); $('searchName').value=''; limpiarFormulario();
}

/* Exportar PDF por asignatura (todos los estudiantes de esa asignatura) */
function exportarPDFPorAsignatura(){
  const asignaturas=[...new Set(Object.values(registros).map(r=>r.asignatura))];
  if(asignaturas.length===0){toast('No hay asignaturas registradas','err');return}
  const sel=prompt(`Ingrese la asignatura a exportar:\n\n${asignaturas.join('\n')}`); if(!sel) return;
  const lista=Object.entries(registros).filter(([_,r])=>r.asignatura.toLowerCase()===sel.trim().toLowerCase());
  if(lista.length===0){toast(`No hay registros para "${sel}"`,'err');return}
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'pt',format:'a4'}); const M=56; const MAXY=780; let y=M;
  doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text(`Registros - Asignatura: ${sel}`,M,y); y+=26;
  doc.setFont('helvetica','normal'); doc.setFontSize(12);
  lista.sort((a,b)=>a[0].localeCompare(b[0])).forEach(([nombre,r],idx)=>{
    const notasStr=r.notas.join(' ‚Ä¢ '); const nums=r.notas.map(parseFloat).filter(n=>!isNaN(n)); const prom=nums.length?(nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2):'N/A';
    const lines=doc.splitTextToSize(`${idx+1}. ${nombre}  |  Notas: ${notasStr}  |  Promedio: ${prom}`, 482);
    lines.forEach(line=>{ if(y>MAXY){doc.addPage(); y=M} doc.text(line,M,y); y+=16; }); y+=6;
  });
  if(y>MAXY){doc.addPage(); y=M}
  doc.setDrawColor(200); doc.line(M,y,M+482,y); y+=16; doc.setFontSize(10); doc.text(`Generado: ${new Date().toLocaleString()}`,M,y);
  doc.save(`Registros_${sanitize(sel)}.pdf`);
}
</script>
</body>
</html>
